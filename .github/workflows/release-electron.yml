name: Build executables and create release

on:
  push:

# on:
#   workflow_dispatch:
#   push:
#     tags:
#       - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    name: Build executables and create release
    runs-on: ubuntu-24.04
    container: electronuserland/builder:22-wine
    env:
      RELEASE_ASSETS: |
        dist/*.exe
        dist/*.zip
    steps:
      - name: Take container home folder ownership
        # necessary to get Wine to work
        run: chown root:root /github/home
      - name: Set GITHUB_ENV
        run: echo "WINEARCH=win64" >> $GITHUB_ENV &&
          echo "DISPLAY=:0.0" >> $GITHUB_ENV &&
          echo "WINEPREFIX=/root/.winepref" >> $GITHUB_ENV &&
          echo "ELECTRON_CACHE=/root/.cache/electron" >> $GITHUB_ENV &&
          echo "ELECTRON_BUILDER_CACHE=/root/.cache/electron-builder" >> $GITHUB_ENV &&
          echo "WINEDEBUG=-all" >> $GITHUB_ENV &&
          echo "WINE_SKIP_DESKTOP_INTEGRATION=1" >> $GITHUB_ENV
          echo "DEBUG=electron-builder" >> $GITHUB_ENV
      - name: More random things
        run: apt-get update && apt-get install -y xvfb
      - name: Configure Wine
        run: winecfg
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update npm
        run: npm update -g npm
      - name: Add safe directory for git submodule usage
        run: git config --global --add safe.directory '*'
      - name: Install node dependencies
        run: npm ci
      - name: Showing wine environment
        run: env | grep WINE
      - name: Build
        run: npm run dist:electron
      - name: List created files
        run: ls -la dist
      - name: Create release and upload assets
        id: upload_initial
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: ${{ env.RELEASE_ASSETS }}
      # backup steps
      - name: Create release and upload assets (retry)
        id: upload_retry
        continue-on-error: true
        if: steps.upload_initial.outcome == 'failure'
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: ${{ env.RELEASE_ASSETS }}
      - name: Upload workflow artifacts as backup
        if: steps.upload_retry.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.RELEASE_ASSETS }}
